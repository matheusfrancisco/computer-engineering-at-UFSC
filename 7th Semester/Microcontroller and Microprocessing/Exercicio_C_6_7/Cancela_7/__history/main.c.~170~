/*C--------------------------------------------------------------------------------------
- FILENAME :        main.c             
-
- DESCRIPTION :
-       Controle de cancela de travessia de ferrovia usando microcontrolador PIC16F877A.
-
- PUBLIC FUNCTIONS :
-       void	trata_INT_ext()
-       void    main()
-
- NOTES :
-			O problema foi resolvido com base nas expecificaï¿½ï¿½es do enunciado.
-
- AUTHOR :  Thiago Raulino Dal Pont     	START DATE :	13 May 16
-
-----------------------------------------------------------------------------------------C*/

/*---------------------------------   ENUNCIADO    --------------------------------------

Desenvolva um sistema embarcado(hardware e software) para controle de uma cancela 
para passagem de trem. Uma saída determinará cancela aberta ou fechada e sensores 
na cancela garantem a posição dela.Um sensor de presença de automóvel faz a cancela 
abrir e depois fecha. Um outro sensor de trem detecta a presença do mesmo e não 
deixa abrir a cancela mesmo com a presença de carro.(usar interrupção)

-----------------------------------------------------------------------------------------*/

//--------------------------------     INCLUDES     -------------------------------------//
#include <main.h>


//---------------------     VARIï¿½VEIS GLOBAIS E CONSTANTES     --------------------------//
const int SENSOR_TREM				= PIN_B0;	// Sensor de presenï¿½a do trem
const int SENSOR_AUTO				= PIN_B1;	// Sensor de presenï¿½a de automï¿½veis
const int SENSOR_CANCELA_FECHADA	= PIN_B2;	// Sensor de cancela fechada
const int SENSOR_CANCELA_ABERTA		= PIN_B3;	// Sensor de cancela aberta
const int SAIDA_FECHANDO			= PIN_B4;	// Saï¿½da de motor em estado 'fechando'
const int SAIDA_ABRINDO				= PIN_B5;	// Saï¿½da de motor em estado 'abrindo'
const int SAIDA_SOM					= PIN_B6;	// Saï¿½da de som
int1 flag, auto_cross;

//----------------------	Controle de Interrupï¿½ï¿½o	Externa    -------------------------//
#INT_ext
void trata_INT_ext() {

	flag = 1;					// Indicador de interrupï¿½ï¿½o   	
   	
	output_high(SAIDA_SOM);		// Aviso sonoro de trem se aproximando.
   	
	// Caso um automï¿½vel esteja cruzando a ferrovia, espera antes de fechar a cancela.
	if (auto_cross == 1) {
		delay_ms(20000);
	}
   	

	while (input(SENSOR_CANCELA_FECHADA) == 1) {
		output_low(SAIDA_ABRINDO);
		output_high(SAIDA_FECHANDO);
	}
   	
	output_low(SAIDA_FECHANDO);	// Apaga a luz que indica a aï¿½ï¿½o de fechamento da cancela.
   	
	delay_ms(10000);		   	
	output_low(SAIDA_SOM);		// Para o alerta sonoro.
}


//----------------------------     FUNï¿½ï¿½O PRINCIPAL     -------------------------------//
void main() {
   	
	port_b_pullups (true);

	// Configuraï¿½ï¿½o das interrupï¿½ï¿½es
	enable_interrupts (global);			// Global
    enable_interrupts (INT_ext);		// Externa
    ext_INT_edge (H_to_L);				// Habilita Falling edge como disparador de interrupï¿½ï¿½o*/
    
    // Inicializaï¿½ï¿½o das saï¿½das.
    output_low(SAIDA_ABRINDO);
    output_low(SAIDA_FECHANDO);
    output_low(SAIDA_SOM);
    
    // Laï¿½o de repetiï¿½ï¿½o infinito
    while (true) {
		flag = 0;
	   	
		// Caso tenha um automï¿½vel em frente a cancela
		if (input (SENSOR_AUTO) == 0 && flag == 0) {
		   	
			if (input(SENSOR_CANCELA_ABERTA) == 1 && flag == 0) {
				output_high(SAIDA_ABRINDO); // aciona a luz e o motor de abrindo simultaneamente.
				output_low(SAIDA_FECHANDO); // apaga a luz de fechando.
		   	
				while(input(SENSOR_CANCELA_ABERTA) == 1 && flag == 0); // Enquanto nï¿½o estiver totalmente aberto, espera.
			   	
				output_low(SAIDA_ABRINDO); // desliga a luz e o motor de abrindo simultaneamente.
			}
		   	
			if (flag == 0) {
			    auto_cross = 1;			// Diz que estï¿½ passando um carro.
				delay_ms(10000);		// O automï¿½vel passa e espera enquanto isso.
			   	
				auto_cross = 0;			// Indica que nï¿½o hï¿½ mais nenhum automï¿½vel atravessando.
			   	
				// Caso a cancela jÃ¡ nÃ£o esteja fechada.
				if ((input(SENSOR_CANCELA_FECHADA) == 1) && (flag == 0)) {
					output_low(SAIDA_ABRINDO); 
					output_high(SAIDA_FECHANDO); 
					// Fechamento da cancela
					while ((input(SENSOR_CANCELA_FECHADA) == 1) && (flag == 0));
				}
			   	
				output_low(SAIDA_FECHANDO); // Apaga a luz de fechando e desliga o motor.
			}
		}
	}
}
