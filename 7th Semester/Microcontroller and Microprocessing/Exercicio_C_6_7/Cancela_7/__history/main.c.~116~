#include <main.h>

/*
ENUNCIADO:

Desenvolva um sistema embarcado(hardware e software) para controle de uma cancela 
para passagem de trem. Uma saída determinará cancela aberta ou fechada e sensores 
na cancela garantem a posição dela.Um sensor de presença de automóvel faz a cancela 
abrir e depois fecha. Um outro sensor de trem detecta a presença do mesmo e não 
deixa abrir a cancela mesmo com a presença de carro.(usar interrupção)

*/

const int SENSOR_TREM				= PIN_B0;	// Sensor de presença do trem
const int SENSOR_AUTO				= PIN_B1;	// Sensor de presença de automóveis
const int SENSOR_CANCELA_FECHADA	= PIN_B2;	// Sensor de cancela fechada
const int SENSOR_CANCELA_ABERTA		= PIN_B3;	// Sensor de cancela aberta
const int SAIDA_FECHANDO			= PIN_B4;	// Saída de motor em estado 'fechando'
const int SAIDA_ABRINDO				= PIN_B5;	// Saída de motor em estado 'abrindo'
const int SAIDA_SOM					= PIN_B6;	// Saída de som
int1 flag, auto_cross;

// Interrupção
#INT_ext
void trata_INT_ext() {

	flag = 1;
   	
	if (auto_cross == 1) {
		delay_ms(20000);
	}
   	
	while (input(SENSOR_CANCELA_FECHADA) == 1) {
		output_low(SAIDA_ABRINDO);
		output_high(SAIDA_FECHANDO);
	}
   	
	output_low(SAIDA_FECHANDO);
   	
	output_high(SAIDA_SOM);
	delay_ms(20000);
	output_low(SAIDA_SOM);
   	
	while(true);
}

// Função principal
void main() {
   	
	port_b_pullups (true);

	// Configuração das interrupções
	enable_interrupts (global);			// Global
    enable_interrupts (INT_ext);		// Externa
    ext_INT_edge (H_to_L);				// Habilita Falling edge como disparador de interrupção*/
    
    
    // Laço de repetição infinito
    while (true) {
		flag = 0;
	   	
		// Caso tenha um automóvel em frente a cancela
		if (input (SENSOR_AUTO) == 0 && flag == 0) {
		   	
			if (input(SENSOR_CANCELA_ABERTA) == 1 && flag == 0) {
				output_high(SAIDA_ABRINDO); // aciona a luz e o motor de abrindo simultaneamente.
				output_low(SAIDA_FECHANDO); 
		   	
				while(input(SENSOR_CANCELA_ABERTA) == 1 && flag == 0); // Enquanto não estiver totalmente aberto, espera.
			}
		   	
			if (flag == 0) {
			    auto_cross = 1;			// Diz que está passando um carro.
				delay_ms(20000);		// Espera o automóvel passar.
			   	
			   	
				if (input(SENSOR_CANCELA_FECHADA) == 1 && flag == 0) {
					output_low(SAIDA_ABRINDO); 
					output_high(SAIDA_FECHANDO); 
					// Fechamento da cancela
					while (input(SENSOR_CANCELA_FECHADA) == 1 && flag == 0);
				}
			   	
				output_low(SAIDA_FECHANDO); // Apaga a luz de fechando e desliga o motor.
			}
		   	
			auto_cross = 0;
		}
	   	
	}
}
